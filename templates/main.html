<!DOCTYPE html>
<head>
<title>Thermostat</title>
<style>

input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
    display: none;
}

input[type=number] {
    -moz-appearance:textfield;
}

.main_flex {
    display: flex;
}

.Rtable {
    display: flex;
    flex-wrap: wrap;
    margin 0 0 3em 0;
    padding: 0;
}
.Rtable-cell {
    box-sizing: border-box;
    flex-grow: 1;
    overflow: hidden;
    list-style: none;
}

.Rtable--2cols > .Rtable-cell { width: 50%; }
.Rtable--3cols > .Rtable-cell { width: 33.33%; }
.Rtable--4cols > .Rtable-cell { width: 25%; }
.Rtable--5cols > .Rtable-cell { width: 20%; }

</style>
</head>
<script src="static/moment.min.js"></script>
<script src="static/Chart.min.js"></script>

<body onLoad="setTimeout(function() {location.reload();}, 60000);">
<div class="main_flex">
    <div>
    Status: {{ enabled }} <br>
    Current Temperature: {{ currentTemp }}&deg;F <br>
    Target Temperature: {{ targetTemp }}&deg;F <br>
    Current Humidity: {{ currentHumidity }}&percnt; <br>
    Current On Value: {{ status }}% <br>
    Today's Runtime: {{ todaysRuntime }} <br>

    <br>
    <form method="post">
        <input type="number" step="any" name="temp" value="{{ targetTemp }}">
        <input type="submit" name="edit_temp" value="Update"> <br>
        <input type="submit" name="decrease_temp" value="Decrease Temp" />
        <input type="submit" name="increase_temp" value="Increase Temp" />
        <br>
        <input type="submit" name="disable" value="Disable" />
        <input type="submit" name="enable" value="Enable" />
        <input type="submit" name="force_on" value="Force On" />
    </form>
    <br>
	PID Tunings: <br>
    <form method="post">
        <input type="number" step="any" name="Kp" value="{{ Kp }}">
        <input type="number" step="any" name="Ki" value="{{ Ki }}">
        <input type="number" step="any" name="Kd" value="{{ Kd }}">
        <input type="submit" name="edit_tunings" value="Update">
    </form>
    </div>
    <div>
    <table>
    <tr>
        <th>Times</th>
        {%- for day in dayNames -%}
        <th>{{ day }}</th>
        {%- endfor -%}
    </tr>
    {%- for row in scheduleRows -%}
    {%- set (time, time_id) = scheduleTimes[loop.index0] -%}
    <tr>
        <th>{{ time }}</th>
        {%- for temp in row -%}
        <td align="right">
        {%- if temp != None -%}
        {%- if temp != "Ignore" -%}
        <form method="post">{{ temp }}&deg;F <input type="submit" name="deleteTime{{ loop.index0 }}{{ time_id }}" value="X"></form>
        {%- else -%}
        <form method="post">Ignore <input type="submit" name="deleteTime{{ loop.index0 }}{{ time_id }}" value="X"></form>
        {%- endif -%}
        {%- else -%}
        {%- if row[0] != None -%}
        <form method="post"><input type="submit" name="ignoreTime{{ loop.index0 }}{{ time_id }}" value="Ignore"></form>
        {%- endif -%}
        {%- endif -%}
        </td>
        {%- endfor -%}
    </tr>
    {%- endfor -%}
    </table>
    <form method="post">
        <select name="schedule_day">
        {%- for day in dayNames -%}
            <option value="{{ loop.index0 }}">{{ day }}</option>
        {%- endfor -%}
        </select>
        <input type="time" name="schedule_time" min="00:00" max="23:59" value="00:00" required>
        <input type="number" step="any" name="schedule_temp" value="{{ targetTemp }}">
        <input type="submit" name="add_time" value="New Entry">
    </form>
    </div>
</div>

<div class="Rtable">
    <div class="Rtable-cell">
        <canvas id="tempDayChart"></canvas>
    </div>
</div>
<div class="Rtable Rtable--2cols">
    <div class="Rtable-cell">
        <canvas id="usageHistoryChart"></canvas>
    </div>
    <div class="Rtable-cell">
        <canvas id="activityChart"></canvas>
    </div>
</div>
<script>
function formatTime1(value) {
    let s = String((value%60) + 100).substr(1);
    let m = String((value/60|0)%60 + 100).substr(1);
    if (value < 3600) { return m+":"+s; }

    let h = (value/3600|0);
    return h+":"+m+":"+s;
}
function formatTime2(value) {
    let ms = String(value%1 + .005).substr(1,3).replace(/\.?0+$/g, '');
    let s = String(((value|0)%60) + 100).substr(1);
    let m = String((value/60|0)%60 + 100).substr(1);
    if (value < 3600) { return m+"m "+s+ms+"s"; }

    let h = (value/3600|0);
    return h+"h "+m+"m "+s+ms+"s";
}

var trackerTimeLabels = [
    {%- for entry in tempHistory -%}
        "{{ entry[0] }}",
    {%- endfor -%}
]
var trackerTempData = [
    {%- for entry in tempHistory -%}
        {{ entry[1] }},
    {%- endfor -%}
]
var trackerHumidityData = [
    {%- for entry in tempHistory -%}
        {{ entry[2] }},
    {%- endfor -%}
]
var trackerOnData = [
    {%- for entry in tempHistory -%}
        {{ entry[3] }},
    {%- endfor -%}
]

var ctx = document.getElementById("usageHistoryChart").getContext("2d");
var usageHistoryChart = new Chart(ctx, {
    type:"bar",
    data: {
        labels: [
            {%- for entry in usageHistory -%}
                "{{ entry[0] }}",
            {%- endfor -%}
        ],
        datasets: [{
            data: [
                {%- for entry in usageHistory -%}
                    {{ entry[1] }},
                {%- endfor -%}
            ],
        }],
    },
    options: {
        interactive: true,
        title: {
            display: true,
            text: "Usage History",
        },
        scales: {
            yAxes: [{
                ticks: {
                    callback: formatTime1
                }
            }]
        },
        tooltips: [{
            callbacks: {
                title: function(tooltipItem, title) { return ''; },
                footer: function(tooltipItem, footer) { return ''; },
                label: function(tooltipItem, data) {
                    return formatTime2(tooltipItem.yLabel);
                },
            }
        }],
        legend: {
            display: false
        },
    }
});

ctx = document.getElementById("activityChart").getContext("2d");
var activityChart = new Chart(ctx, {
    type: "line",
    data: {
        labels: trackerTimeLabels,
        datasets: [{
            label: "On Value",
            fill: true,
            lineTension: 0,
            pointRadius: 0,
            pointHitRadius: 4,
            data: trackerOnData,
        }]
    },
    options: {
        scales: {
            xAxes: [{
                type: "time",
            }],
            yAxes: [{
                ticks: {
                    min: 0,
                    max: 1,
                    callback: function(value) { return 100*value + "%"; }
                }
            }],
        },
        tooltips: [{
        }],
        legend: {
            display: false
        },
    },
});

ctx = document.getElementById("tempDayChart").getContext("2d");
var temperatureChart = new Chart(ctx, {
    type: "line",
    data: {
        labels: trackerTimeLabels,
        datasets: [{
            label: "Temperature",
            borderColor: "#ff0000",
            backgroundColor: "#ff0000",
            fill: false,
            yAxisID: "Temperature",
            lineTension: 0,
            pointRadius: 0,
            pointHitRadius: 4,
            data: trackerTempData,
        }, {
            label: "Humidity",
            borderColor: "#0000ff",
            backgroundColor: "#0000ff",
            fill: false,
            yAxisID: "Humidity",
            lineTension: 0,
            pointRadius: 0,
            pointHitRadius: 4,
            data: trackerHumidityData,
        }]
    },
    options: {
        responsive: true,
        scales: {
            xAxes: [{
                type: "time",
            }],
            yAxes: [{
                id: "Temperature",
                ticks: {
                    callback: function(value) { return value + "\u{2109}"; }
                }
            }, {
                id: "Humidity",
                position: "right",
                ticks: {
                    callback: function(value) { return 100*value + "%"; }
                }
            }],
        },
        tooltips: [{
            mode: "x",
            enabled: true,
            intersect: true,
        }],
        legend: {
            position: "right"
        },
    },
});

</script>
</body>
</html>
